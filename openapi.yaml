openapi: 3.0.3
info:
  title: Calendar Aggregator API
  description: |
    A powerful GUID-based calendar aggregation API that combines multiple iCal feeds into unified calendar collections.
    
    Features:
    - **Create calendar collections** with unique GUIDs for secure access
    - **Real-time calendar aggregation** without persistent storage
    - **Combine multiple calendars** from different sources (Google Calendar, Outlook, Apple Calendar, etc.)
    - **Validate and test** calendar URLs before adding them
    - **Direct iCal feed output** compatible with all calendar applications
    - **Concurrent fetching** with error handling and timeout protection
    
    Built with Next.js 15, TypeScript, and modern serverless architecture.
  version: 2.0.0
  contact:
    name: Calendar Aggregator Support
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://calendar-aggregator-jnmxvdzgo-melbourne-computing.vercel.app/api
    description: Production server (Vercel)

paths:
  /collections:
    get:
      summary: List all calendar collections
      description: Retrieve all configured calendar collections with their metadata
      operationId: getCollections
      tags:
        - Collections
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  collections:
                    type: array
                    items:
                      $ref: '#/components/schemas/CalendarCollection'
                  count:
                    type: integer
                    description: Total number of collections
              example:
                collections:
                  - guid: "4fac5413-98b8-45d1-a8b3-1c26feda1941"
                    name: "Work & Personal"
                    description: "Combined work and personal calendars"
                    calendars:
                      - id: 1
                        name: "Work Calendar"
                        url: "https://calendar.google.com/calendar/ical/work@example.com/public/basic.ics"
                        color: "#3b82f6"
                        enabled: true
                        syncStatus: "idle"
                        createdAt: "2024-01-01T00:00:00.000Z"
                      - id: 2
                        name: "Personal Calendar"
                        url: "https://outlook.live.com/owa/calendar/xyz/reachcalendar.ics"
                        color: "#ef4444"
                        enabled: true
                        syncStatus: "idle"
                        createdAt: "2024-01-01T00:00:00.000Z"
                    createdAt: "2024-01-01T00:00:00.000Z"
                count: 1
        '500':
          $ref: '#/components/responses/ServerError'

    post:
      summary: Create a new calendar collection
      description: Create a new collection of calendar sources with URL validation and GUID generation
      operationId: createCollection
      tags:
        - Collections
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCollectionRequest'
            example:
              name: "Work & Personal"
              description: "Combined work and personal calendars"
              calendars:
                - name: "Work Calendar"
                  url: "https://calendar.google.com/calendar/ical/work@example.com/public/basic.ics"
                  color: "#3b82f6"
                  enabled: true
                - name: "Personal Calendar"
                  url: "webcal://outlook.live.com/owa/calendar/xyz/reachcalendar.ics"
                  color: "#ef4444"
                  enabled: true
      responses:
        '201':
          description: Collection created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalendarCollection'
        '400':
          description: Invalid request or calendar validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              examples:
                invalid_calendars:
                  summary: Calendar validation failed
                  value:
                    error: "Calendar validation failed"
                    details: ["Calendar 1 (Work): Invalid URL format", "Calendar 2 (Personal): Unable to connect to server"]
                missing_fields:
                  summary: Missing required fields
                  value:
                    error: "Collection name is required"
        '409':
          description: Collection name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Collection name already exists"
        '500':
          $ref: '#/components/responses/ServerError'

  /collections/{guid}:
    get:
      summary: Get a specific calendar collection
      description: Retrieve details of a collection by its GUID
      operationId: getCollection
      tags:
        - Collections
      parameters:
        - name: guid
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Collection GUID
          example: "4fac5413-98b8-45d1-a8b3-1c26feda1941"
      responses:
        '200':
          description: Collection found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalendarCollection'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'

    put:
      summary: Update a calendar collection
      description: Update collection properties and calendars with URL validation
      operationId: updateCollection
      tags:
        - Collections
      parameters:
        - name: guid
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Collection GUID
          example: "4fac5413-98b8-45d1-a8b3-1c26feda1941"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCollectionRequest'
            example:
              name: "Updated Work & Personal"
              description: "Updated description"
              calendars:
                - name: "Work Calendar"
                  url: "https://calendar.google.com/calendar/ical/work@example.com/public/basic.ics"
                  color: "#3b82f6"
                  enabled: true
      responses:
        '200':
          description: Collection updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalendarCollection'
        '400':
          description: Invalid request or calendar validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Collection name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/ServerError'

    delete:
      summary: Delete a calendar collection
      description: Permanently remove a calendar collection
      operationId: deleteCollection
      tags:
        - Collections
      parameters:
        - name: guid
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Collection GUID
          example: "4fac5413-98b8-45d1-a8b3-1c26feda1941"
      responses:
        '200':
          description: Collection deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
              example:
                message: "Collection deleted successfully"
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'

  /calendar/{guid}:
    get:
      summary: Get aggregated calendar feed
      description: |
        Real-time calendar aggregation endpoint that fetches and combines multiple iCal feeds
        into a single unified calendar. This is the main endpoint for consuming the aggregated calendar.
        
        The response is a standard iCal (.ics) file that can be subscribed to by any calendar application
        including Google Calendar, Apple Calendar, Outlook, and others.
        
        Features:
        - Real-time fetching from source calendars
        - Event deduplication by UID
        - Timezone preservation and combination
        - Concurrent processing with timeout protection
        - Proper iCal formatting with headers
      operationId: getAggregatedCalendar
      tags:
        - Calendar Feed
      parameters:
        - name: guid
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Collection GUID for the calendar to aggregate
          example: "4fac5413-98b8-45d1-a8b3-1c26feda1941"
      responses:
        '200':
          description: Aggregated iCal feed
          headers:
            Content-Type:
              description: Standard iCal MIME type
              schema:
                type: string
                example: "text/calendar; charset=utf-8"
            Content-Disposition:
              description: Suggested filename for download
              schema:
                type: string
                example: 'attachment; filename="Work-Personal.ics"'
            Cache-Control:
              description: Caching policy for calendar clients
              schema:
                type: string
                example: "public, max-age=300"
          content:
            text/calendar:
              schema:
                type: string
                description: Complete iCal feed with combined events
              example: |
                BEGIN:VCALENDAR
                VERSION:2.0
                PRODID:-//Calendar Aggregator//EN
                CALSCALE:GREGORIAN
                METHOD:PUBLISH
                X-WR-CALNAME:Work & Personal
                X-WR-CALDESC:Combined work and personal calendars
                BEGIN:VTIMEZONE
                TZID:America/New_York
                BEGIN:STANDARD
                DTSTART:20231105T020000
                TZOFFSETFROM:-0400
                TZOFFSETTO:-0500
                RRULE:FREQ=YEARLY;BYMONTH=11;BYDAY=1SU
                TZNAME:EST
                END:STANDARD
                END:VTIMEZONE
                BEGIN:VEVENT
                UID:event123@example.com
                DTSTART;TZID=America/New_York:20240101T120000
                DTEND;TZID=America/New_York:20240101T130000
                SUMMARY:Team Meeting
                DESCRIPTION:Weekly team sync
                LOCATION:Conference Room A
                END:VEVENT
                END:VCALENDAR
        '404':
          description: Collection not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Collection not found"
        '500':
          description: Calendar aggregation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                fetch_timeout:
                  summary: Calendar fetch timeout
                  value:
                    error: "Calendar aggregation failed"
                    details: "Timeout fetching calendar feeds"
                parse_error:
                  summary: iCal parsing error
                  value:
                    error: "Calendar aggregation failed"
                    details: "Failed to parse iCal content"

    head:
      summary: Check calendar feed availability
      description: |
        Check if a calendar collection exists and can be aggregated without downloading the full content.
        Useful for calendar clients to verify feed availability before subscription.
      operationId: checkCalendarFeed
      tags:
        - Calendar Feed
      parameters:
        - name: guid
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Collection GUID
          example: "4fac5413-98b8-45d1-a8b3-1c26feda1941"
      responses:
        '200':
          description: Calendar feed is available
          headers:
            Content-Type:
              schema:
                type: string
                example: "text/calendar; charset=utf-8"
            Content-Length:
              description: Approximate size of the calendar feed
              schema:
                type: string
                example: "874000"
        '404':
          description: Collection not found
        '500':
          description: Calendar aggregation error

  /health:
    get:
      summary: Health check
      description: Check API health and status
      operationId: healthCheck
      tags:
        - System
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string
                    example: "1.0.0"

components:
  schemas:
    CalendarSource:
      type: object
      required:
        - id
        - url
        - name
        - color
        - enabled
        - createdAt
        - syncStatus
      properties:
        id:
          type: integer
          description: Unique calendar identifier
        url:
          type: string
          format: uri
          description: iCal feed URL (webcal:// URLs are converted to https://)
        name:
          type: string
          description: Human-readable calendar name
        color:
          type: string
          pattern: '^#[0-9a-fA-F]{6}$'
          description: Hex color code for calendar display
          example: "#3b82f6"
        enabled:
          type: boolean
          description: Whether calendar is active for syncing
        createdAt:
          type: string
          format: date-time
          description: Calendar creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last modification timestamp
        lastSyncAt:
          type: string
          format: date-time
          nullable: true
          description: Last successful sync timestamp
        syncStatus:
          type: string
          enum: [idle, syncing, error, success]
          description: Current sync status
        errorMessage:
          type: string
          nullable: true
          description: Last error message if sync failed

    CreateCalendarRequest:
      type: object
      required:
        - url
        - name
      properties:
        url:
          type: string
          format: uri
          description: iCal feed URL (supports webcal:// protocol)
          example: "https://calendar.google.com/calendar/ical/example@gmail.com/public/basic.ics"
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Calendar display name
          example: "Work Calendar"
        color:
          type: string
          pattern: '^#[0-9a-fA-F]{6}$'
          description: Hex color code for calendar display
          default: "#3b82f6"
        enabled:
          type: boolean
          description: Whether calendar should be enabled for syncing
          default: true

    UpdateCalendarRequest:
      type: object
      properties:
        url:
          type: string
          format: uri
          description: New iCal feed URL
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: New calendar display name
        color:
          type: string
          pattern: '^#[0-9a-fA-F]{6}$'
          description: New hex color code
        enabled:
          type: boolean
          description: Whether calendar should be enabled

    CalendarEvent:
      type: object
      required:
        - id
        - title
        - start
        - end
        - isAllDay
        - isRecurring
        - calendarId
        - sourceId
      properties:
        id:
          type: string
          description: Unique event identifier
        title:
          type: string
          description: Event title/summary
        description:
          type: string
          nullable: true
          description: Event description
        start:
          type: string
          format: date-time
          description: Event start time (ISO 8601)
        end:
          type: string
          format: date-time
          description: Event end time (ISO 8601)
        location:
          type: string
          nullable: true
          description: Event location
        organizer:
          type: object
          nullable: true
          properties:
            name:
              type: string
            email:
              type: string
              format: email
        attendees:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              email:
                type: string
                format: email
              status:
                type: string
                enum: [accepted, declined, tentative, needs-action]
        isAllDay:
          type: boolean
          description: Whether event spans entire day(s)
        isRecurring:
          type: boolean
          description: Whether event has recurrence rules
        recurrenceRule:
          type: string
          nullable: true
          description: RFC 5545 recurrence rule
        timezone:
          type: string
          nullable: true
          description: Event timezone
        status:
          type: string
          enum: [confirmed, tentative, cancelled]
          nullable: true
        categories:
          type: array
          items:
            type: string
          description: Event categories/tags
        url:
          type: string
          format: uri
          nullable: true
          description: Event URL
        calendarId:
          type: integer
          description: Source calendar ID
        sourceId:
          type: string
          description: Original event ID from source calendar

    AggregatedResponse:
      type: object
      required:
        - events
        - pagination
        - filters
        - timestamp
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/CalendarEvent'
        pagination:
          type: object
          properties:
            limit:
              type: integer
            offset:
              type: integer
            total:
              type: integer
        filters:
          type: object
          properties:
            start:
              type: string
              format: date-time
              nullable: true
            end:
              type: string
              format: date-time
              nullable: true
            calendars:
              type: array
              items:
                type: string
            search:
              type: string
              nullable: true
        timestamp:
          type: string
          format: date-time
          description: Response generation timestamp

    SyncResult:
      type: object
      required:
        - status
        - startedAt
        - completedAt
        - calendars
        - eventsProcessed
        - errors
        - calendarResults
      properties:
        status:
          type: string
          enum: [completed, partial, failed]
          description: Overall sync operation status
        startedAt:
          type: string
          format: date-time
          description: Sync start timestamp
        completedAt:
          type: string
          format: date-time
          description: Sync completion timestamp
        calendars:
          type: integer
          description: Number of calendars processed
        eventsProcessed:
          type: integer
          description: Total events processed across all calendars
        errors:
          type: array
          items:
            type: string
          description: Global errors encountered during sync
        calendarResults:
          type: array
          items:
            $ref: '#/components/schemas/SyncStatus'

    SyncStatus:
      type: object
      required:
        - calendarId
        - status
        - startedAt
        - eventsProcessed
        - eventsAdded
        - eventsUpdated
        - eventsRemoved
        - errors
      properties:
        calendarId:
          type: integer
          description: Calendar identifier
        status:
          type: string
          enum: [pending, syncing, completed, error]
          description: Individual calendar sync status
        startedAt:
          type: string
          format: date-time
          description: Calendar sync start time
        completedAt:
          type: string
          format: date-time
          nullable: true
          description: Calendar sync completion time
        eventsProcessed:
          type: integer
          description: Number of events processed from this calendar
        eventsAdded:
          type: integer
          description: Number of new events added
        eventsUpdated:
          type: integer
          description: Number of existing events updated
        eventsRemoved:
          type: integer
          description: Number of events removed
        errors:
          type: array
          items:
            type: string
          description: Errors specific to this calendar

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message

    ValidationError:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Main error message
        details:
          type: string
          description: Detailed error information
        warnings:
          type: array
          items:
            type: string
          description: Additional warnings

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Calendar not found"

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Internal server error"

tags:
  - name: Calendars
    description: Calendar source management operations
  - name: Synchronization
    description: Calendar data synchronization operations
  - name: Events
    description: Aggregated event retrieval operations
  - name: System
    description: System health and status operations